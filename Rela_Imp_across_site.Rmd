---
title: "Rela_Imp_across_site"
author: "Ngoc Nguyen"
date: "2024-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("Functions_for_Spectral_Clustering.R")
library(ggnewscale)
library(segmented)
library(greekLetters)
library(relaimpo)
library(ggpattern)
```

#Reading x variables
```{r}
x_df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/decay_stat_all_site.csv")
x_df <- x_df[, 2:6]

```

#####extract y variables
#drying-rewetting event frequency
```{r}
df_manual <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Data/Birch effect Manual Label - shortcut.csv")
df_manual$SOP <- as.Date(df_manual$SOP)
df_manual$EOP <- as.Date(df_manual$EOP)
df_manual$Year <- format(df_manual$SOP, "%Y")

year_df <- ddply(df_manual, .(SITE_ID), mutate, count = length(unique(Year)))

pulse_no_df <- df_manual %>% count("SITE_ID")
pulse_no_df$freq <- pulse_no_df$freq/unique(year_df$count)

colnames(pulse_no_df) <- c("SITE_ID", "event_per_yr")

```

#Mean change_EF and dryness_index
```{r}
df_3var <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/3vars_all_sites.csv")
df_climate <- df_3var %>% group_by(SITE_ID) %>% summarise(across(c(dryness_index, change_EF, C_contribution), mean, na.rm = TRUE))
```

#Mean GPP, Tsoil, Tair, SW
```{r}
dir <- "/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Data/HH_data_time_converted/"
file_list <- list.files(dir)
df_list <- list()

for(i in 1:length(file_list)) {
  ##Reading each file
  file_path <- paste(dir, file_list[i], sep = "")
  df_full <- read.csv(file_path, header = TRUE)
  df_full$Time <- as.Date(df_full$Time)
  df_EF <- daytimeEF_df(df_full)
  df_full <- full_join(df_full, df_EF, by= "Time")
  #reading the pulse df for each site
  site_name <- substr(file_list[i], start = 1, stop = 6)
  
  df_sub <- subset(df_full, NEE_VUT_REF_QC == 0 & TA_F_MDS_QC == 0 & SW_IN_F_MDS_QC == 0 & GPP_NT_VUT_REF > -9999)
  
  df_sub_mean <- df_sub %>% 
    summarise(across(c(NEE_VUT_REF, GPP_NT_VUT_REF, Daily_EF, TA_F_MDS, SW_IN_F_MDS), mean))
  df_sub_mean$NEP_90 <- abs(quantile(df_sub$NEE_VUT_REF, 0.1))
  df_sub_mean$SITE_ID <- site_name
  df_list[[i]] <- df_sub_mean
}

all_pulse_df <- NULL
for(i in 1:length(df_list)) {
  all_pulse_df <- rbind(all_pulse_df, df_list[[i]])
}
colnames(all_pulse_df) <- c("NEE", "GPP", "EF", "TA", "SW", "NEP_90", "SITE_ID")
all_pulse_df <- all_pulse_df[, c(1, 2, 4, 5, 6, 7)]
site_var_df <- all_pulse_df
write.csv(all_pulse_df, "/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/site_predictors.csv")
site_var_df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/site_predictors.csv")


```

#Aridity Index
```{r}
AI_df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Data/aridity_index_data.csv")
AI_df_sub <- subset(AI_df, SITE_ID %in% unique(df_manual$SITE_ID))
AI_df_sub <- AI_df_sub[!duplicated(AI_df_sub$SITE_ID), ]
AI_df_final <- AI_df_sub[, c("SITE_ID", "TC_aridity")]
colnames(AI_df_final) <- c("SITE_ID", "AI")

site <- unique(df$SITE_ID)
df_new <- subset(AI_df, TC_aridity < 0.65 & SITE_ID %in% site)
```


#Soilgrids (C:N, soil pH, SOC, %clay)
```{r}
df_soilgrids <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Data/soilGrids_full_data.csv")
#variable names
df_soilgrids_sub <- df_soilgrids[, c("SITE_ID", "phh2o_0.5cm_mean", "nitrogen_0.5cm_mean", "soc_0.5cm_mean", "clay_0.5cm_mean", "sand_0.5cm_mean", "silt_0.5cm_mean")]
colnames(df_soilgrids_sub) <- c("SITE_ID", "Soil pH", "Soil N", "SOC", "Clay", "Sand", "Silt")
df_soilgrids_sub <- subset(df_soilgrids_sub, SITE_ID %in% unique(df_manual$SITE_ID))
df_soilgrids_sub$`Soil pH` <- df_soilgrids_sub$`Soil pH`/10
df_soilgrids_sub$`Clay_%` <- df_soilgrids_sub$`Clay`/(df_soilgrids_sub$`Clay`+df_soilgrids_sub$`Sand`
                            +df_soilgrids_sub$`Silt`)*100
df_soilgrids_sub$`SOC` <- df_soilgrids_sub$`SOC`/10 #g/kg
df_soilgrids_sub$`Soil N` <- df_soilgrids_sub$`Soil N`/100 #g/kg
df_soilgrids_sub$`Soil C:N` <- df_soilgrids_sub$`SOC`/df_soilgrids_sub$`Soil N`

```

#NEPmax
```{r}
mirco_df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Data/InputDataMigliavacca2021.csv")
colnames(mirco_df)
mirco_sub <- subset(mirco_df, SITE_ID %in% unique(df_manual$SITE_ID))
```


#merge all df
```{r}
merge_df <- list(x_df, pulse_no_df, df_climate, site_var_df, AI_df_final, df_soilgrids_sub) %>% reduce(full_join, by = "SITE_ID")
write.csv(merge_df, "/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/Rela_Imp_dataset.csv")
#significant site 
merge_df <- subset(merge_df, ini_condition_p < 0.05 & decay_factor_p < 0.05)


df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/Rela_Imp_dataset.csv")
```


#Reviewer answer about relationship betweenn AI and GPP, pulse intensity
```{r}
df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/Rela_Imp_dataset.csv")
df <- subset(df, ini_condition_p < 0.05 & decay_factor_p < 0.05)

#GPP and wetness (AI index) relationship
png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/GPP-AI-scatter.png",  width     = 4.2,
    height    = 2.5,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(df) + geom_point(aes(AI, GPP, color = SITE_ID)) + theme_bw() +  
  geom_smooth(aes(AI, GPP), method = "lm", se=FALSE, color = "black") +
  theme(
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Aridity Index (Higher = Wetter)") + ylab("GPP") 
dev.off()

png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/intensity-AI-scatter.png",  width     = 4.2,
    height    = 2.5,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(df) + geom_point(aes(AI, ini_condition, color = SITE_ID)) + theme_bw() +  
  geom_smooth(aes(AI, ini_condition), method = "lm", se=FALSE, color = "black") +
  theme(
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Aridity Index (Higher = Wetter)") + ylab("Site-specific Pulse Intensity") 
dev.off()

png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/intensity-GPP-scatter.png",  width     = 4.2,
    height    = 2.5,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(df) + geom_point(aes(GPP, ini_condition, color = SITE_ID)) + theme_bw() +  
  geom_smooth(aes(GPP, ini_condition), method = "lm", se=FALSE, color = "black") +
  theme(
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Aridity Index (Higher = Wetter)") + ylab("Site-specific Pulse Intensity") 
dev.off()

summary(lm(GPP~ini_condition, df))
summary(lm(GPP~ini_condition, df))$r.squared**0.5


unique(df$SITE_ID)
```
#adding continent to address Reviewer 2's comments
```{r}
df$continent <- 0
df$continent[which(df$SITE_ID %in% c("AU-ASM", "AU-DaP", "AU-Dry", "AU-Rig", "AU-Stp"))] <- 1

df
```

#initial condition
```{r}
merge_df_sub <- df[, c("ini_condition", "dryness_index", "change_EF", "GPP", "TA", "SW", "AI", "Soil.pH", "SOC", "Clay_.", "continent")]

result <- boot.relimp(ini_condition ~ ., merge_df_sub, b = 100, type = c("lmg"))

rel_imp <- booteval.relimp(result, bty="bca", sort = TRUE)

variable <- c("Pre-pulse EF", paste(greeks("Delta"), "EF", sep = ""),
             "GPP", "Tair", "Rg", "P/PET", "Soil pH", "SOC", "%Clay", "hemisphere")
value <- melt(rel_imp$lmg)$value
stat_ini <- data.frame(variable, value)
stat_ini$lower.CI <- rel_imp$lmg.lower[1,]
stat_ini$upper.CI <- rel_imp$lmg.upper[1,]
stat_ini$std <- (stat_ini$upper.CI - stat_ini$lower.CI)/2/1.96
stat_ini <- stat_ini %>% arrange(desc(value))
var_order <- stat_ini$variable
#-------------------------
png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/hemisphere_barplot_rela_initial_condition.png",  width     = 4.5,
    height    = 3.25,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(stat_ini, aes(y = value*100, x = reorder(variable, -value))) + geom_bar_pattern(stat = "identity", fill = "white", pattern = 'stripe', pattern_spacing = 0.05, pattern_color = "#3c5488", color = "#3c5488", alpha = 0.7) + 
  geom_errorbar(aes(ymin = value*100 - std*100,
                    ymax = value*100 + std*100),
                width = 0.1,
                position = position_dodge(0.7)) +
  labs(title = paste("Variance explained by all predictors: ", round(rel_imp$R2*100, 1), " %", sep = "")) +
  theme_bw() + 
  theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(1, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Drivers") + ylab("% variance explained") 
dev.off()

```


#decaying factor or duration
```{r}
merge_df_sub <- merge_df[, c("decay_factor", "dryness_index", "change_EF", "GPP", "TA", "SW", "AI", "Soil pH", "SOC", "Clay")]
#model <- lm(decay_factor ~ ., merge_df_sub)
result <- boot.relimp(decay_factor ~ ., merge_df_sub, b = 100, type = c("lmg"))

rel_imp <- booteval.relimp(result, bty="bca", sort = TRUE)

variable <- c("Pre-pulse EF", paste("Initial ", greeks("Delta"), "EF", sep = ""),
             "GPP", "Tair", "Rg", "P/PET", "Soil pH", "SOC", "%Clay")
value <- melt(rel_imp$lmg)$value
stat_decay <- data.frame(variable, value)
stat_decay$lower.CI <- rel_imp$lmg.lower[1,]
stat_decay$upper.CI <- rel_imp$lmg.upper[1,]
stat_decay$std <- (stat_decay$upper.CI - stat_decay$lower.CI)/2/1.96
stat_decay <- stat_decay %>% arrange(desc(value))

stat_decay$variable <- factor(stat_decay$variable, levels = var_order)
#-------------------------
png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/barplot_rela_decayingfactor.png",  width     = 4.5,
    height    = 3.25,
    units     = "in",
    res       = 1200,
    pointsize = 4)

  ggplot(stat_decay, aes(y = value*100, x = variable)) + geom_bar(stat = "identity", fill = "#00a087", alpha = 0.7) + 
    geom_bar_pattern(stat = "identity", fill = "white", pattern = 'stripe', pattern_spacing = 0.05, pattern_color = "#00a087", color = "#00a087", alpha = 0.7) + 
    geom_errorbar(aes(ymin = value*100 - std*100,
                    ymax = value*100 + std*100),
                width = 0.1,
                position = position_dodge(0.7)) +
      labs(title = paste("Variance explained by all predictors: ", round(rel_imp$R2*100, 1), " %", sep = "")) +
  theme_bw() + 
  theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(1, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Drivers") + ylab("% variance explained")
dev.off()


```



#pulse frequency
```{r}
merge_df_sub <- merge_df[, c("event_per_yr", "dryness_index", "change_EF", "GPP", "TA", "SW", "AI", "Soil pH", "SOC", "Clay_%")]
model <- lm(event_per_yr ~ ., merge_df_sub)
rel_imp <- calc.relimp(model, type = "lmg")
variable <- c("Pre-pulse EF", paste("Initial ", greeks("Delta"), "EF", sep = ""),
             "GPP", "Tair", "SW", "Aridity Index", "Soil pH", "SOC", "%Clay")
value <- melt(rel_imp$lmg)$value
stat_ini <- data.frame(variable, value)
#-------------------------
png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/barplot_rela_event_per_yr.png",  width     = 4.5,
    height    = 3.25,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(stat_ini, aes(y = value*100, x = variable)) + geom_bar(stat = "identity", fill = "#00a087", alpha = 0.7) + 
  labs(title = paste("Variance explained by model: ", round(rel_imp$R2*100, 1), " %", sep = "")) +
  theme_bw() + 
  theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(1, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("Drivers") + ylab("% variance explained") 
dev.off()


```

#Initial condition vs. Aridity Index
```{r}
#-------------------------
png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/AI-ini-condition.png",  width     = 3.25,
    height    = 3.25,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(merge_df_sub, aes(AI, ini_condition)) + geom_point() + geom_smooth(method = "lm", se = FALSE, color = "black") +
  theme_bw() + 
  theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(0.5, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
  xlab("AI") + ylab("ymax") 
dev.off()


summary(lm(SOC~GPP, merge_df_sub))

sqrt(summary(lm(SOC~GPP, merge_df_sub))$r.squared)


```

#Partial Dependence Analysis
```{r}
# Load necessary libraries
library(randomForest)
library(pdp)
library(patchwork)


# Random Forest Model: Predicting 'mpg' (miles per gallon)
set.seed(42)
df <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/Rela_Imp_dataset.csv")
df <- subset(df, ini_condition_p < 0.05 & decay_factor_p < 0.05)

merge_df_sub <- df[, c("ini_condition", "dryness_index", "change_EF", "GPP", "TA", "SW", "AI", "Soil.pH", "SOC", "Clay_.")]

#colnames(merge_df_sub) <- c("ini_condition", "Pre-pulse EF", "ΔEF", "GPP", "Tair", "Rg", "P/PET", "Soil pH", "SOC", "%Clay")

rf_model <- randomForest(ini_condition ~ ., data = merge_df_sub, ntree = 100)

# Partial Dependence Plot for a Single Variable (e.g., 'hp')
predictor =  c("dryness_index", "change_EF", "GPP", "TA", "SW", "AI", "Soil.pH", "SOC", "Clay_.")

# Create a list to store the plots
plot_list <- list()

for(i in 1:length(predictor)) {
  pdp_hp <- partial(rf_model, pred.var = predictor[i], train = merge_df_sub)
  
  # Convert to ggplot if needed
  plot_list[[i]] <- autoplot(pdp_hp, linewidth = 1, color = "#3c5488") + theme_bw() +
    theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(0.5, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank()) +
    ylab(expression(alpha[s])) + ylim(5.9, 9.1)
}

# Combine all plots into one figure
final_plot <- wrap_plots(plot_list) + plot_layout(ncol = 3)  # Adjust ncol as needed

png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/PDP_ini_condition.png",  width     = 15,
    height    = 12,
    units     = "in",
    res       = 1200,
    pointsize = 4)

print(final_plot)

dev.off()


```



#EF spatial and temporal distribution
```{r}

dir <- "/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/FluxPulse_ver/FluxPulsev1.1/"

file_list <- list.files(dir)
df_final <- list()

for(j in 1:length(file_list)) {
  ##Reading each file
  file_path <- paste(dir, file_list[j], sep = "")
  df_site <- read.csv(file_path, header = TRUE) 
  site_name <- substr(file_list[j], start = 1, stop = 6)

  EF_array <- unique(df_site$Daily_EF)
  SITE_ID <- rep(site_name, length(EF_array))
  df_sub <- data.frame(SITE_ID, EF_array)
  colnames(df_sub) <- c("SITE_ID", "EF")
  
  df_final[[j]] = df_sub
}
df_final

all_EF_df <- NULL
for(i in 1:length(df_final)) {
    all_EF_df <- rbind(all_EF_df, df_final[[i]])
}          

#write.csv(all_EF_df, "/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/EF_all_sites.csv")

png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/EF_range.png",  width     = 18,
    height    = 12,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(all_EF_df) + geom_boxplot(aes(EF, SITE_ID), outlier.shape = NA) + theme_bw() +
   theme(
  axis.text.y = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.title.y = element_text(size = 15),
  axis.title.x = element_text(size = 15),
  legend.key.size = unit(0.5, 'cm'),
  legend.text = element_text(size=13),
  legend.title = element_text(size=13),
  panel.grid.major = element_blank() , panel.grid.minor = element_blank())
dev.off()



```
```{r}
mean_list <- c()
std_list <- c()

for(i in unique(all_EF_df$SITE_ID)) {
  df_sub <- subset(all_EF_df, SITE_ID == i)
  mean_list <- append(mean_list, mean(na.omit(df_sub$EF)))
  std_list <- append(std_list, sd(na.omit(df_sub$EF)))
}


df <- data.frame(unique(all_EF_df$SITE_ID), mean_list, std_list)
min(df$mean_list)
df

```


#pre-, post- EF
```{r}
df_all <- read.csv("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Datasets/3vars_all_sites.csv")

colnames(df_all)
hist(df_all$change_EF, 100, xlim = c(-0.5,1))


png("/Users/ngocnguyen/Library/CloudStorage/Box-Box/Projects/Birch_effect_paper/Results/Figures/19_sites_manual/change_EF_hist.png",  width     = 7,
    height    = 4,
    units     = "in",
    res       = 1200,
    pointsize = 4)
ggplot(df_all) + geom_histogram(aes(x = change_EF), color = "black", bins = 100, fill = "white") + theme_bw() + geom_vline(xintercept = 0, color = "red", linetype = 6) + xlim(-0.4, 1)
dev.off()

mean(na.omit(df_all$change_EF))
sd(na.omit(df_all$change_EF))

subset(df_all, change_EF > 0)
251
1321
```






















